<div class="flex flex-col gap-4 justify-center">
  <div class="flex w-full justify-center">
    <span class="text-2xl font-bold">Editar Template</span>
  </div>
  <div>
    <%= form_with(model: @template, url: template_path(@template), method: :patch, local: true) do |form| %>
      <div class="grid grid-cols-1 gap-4">
        <div class="flex items-center gap-4">
          <%= form.label :name %>
          <%= form.text_field :name, class: 'form-control' %>
        </div>

        <div id="questions">
          <% @template.template_questions.each_with_index do |question, index| %>
            <div class="bg-white rounded-md p-4 question-fields" data-question-index="<%= index %>">
              <div class="grid grid-cols-1 gap-4">
                <div class="flex items-center gap-4">
                  <%= form.label :title, "Title", for: "template_template_questions_attributes_#{index}_title" %>
                  <%= form.text_field :title, value: question.title, name: "template[template_questions_attributes][#{index}][title]", id: "template_template_questions_attributes_#{index}_title", class: 'form-control' %>
                </div>
                <div class="flex items-center gap-4">
                  <%= form.label :question_type, "Question Type", for: "template_template_questions_attributes_#{index}_question_type" %>
                  <%= form.select :question_type, options_for_select([['Radio', 'radio'], ['Checkbox', 'checkbox'], ['Text', 'text']], question.question_type), name: "template[template_questions_attributes][#{index}][question_type]", id: "template_template_questions_attributes_#{index}_question_type", class: 'form-control', data: { role: "type-select" } %>
                </div>
                <div class="alternatives-container <%= 'hidden' unless ['radio', 'checkbox'].include?(question.question_type) %>" data-role="alternatives-container">
                  <div class="flex items-center gap-4">
                    <button type="button" class="btn btn-secondary" data-role="add-alternative">Add Alternative</button>
                  </div>
                  <div class="alternatives-list" data-role="alternatives-list">
                    <% if ['radio', 'checkbox'].include?(question.question_type) %>
                      <% JSON.parse(question.content).each_with_index do |alt, alt_index| %>
                        <div class="flex items-center gap-4 alternative-field">
                          <label for="alternative_<%= index %>_<%= alt_index %>">Alternative</label>
                          <input type="text" class="form-control alternative-input" name="template[template_questions_attributes][<%= index %>][alternatives][<%= alt_index %>][content]" value="<%= alt %>">
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <div class="flex w-full justify-center">
          <button type="button" id="add-question" class="btn btn-secondary">Add Question</button>
        </div>
        
        <div class="flex w-full justify-center">
          <%= form.submit 'Update Template', class: 'btn btn-primary' %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<%= javascript_tag do %>
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('add-question').addEventListener('click', function() {
      var questionsDiv = document.getElementById('questions');
      var newQuestionIndex = questionsDiv.children.length;
      var newQuestionFields = 
        <div class="bg-white rounded-md p-4 question-fields" data-question-index="${newQuestionIndex}">
          <div class="grid grid-cols-1 gap-4">
            <div class="flex items-center gap-4">
              <label for="template_template_questions_attributes_${newQuestionIndex}_title">Title</label>
              <input type="text" name="template[template_questions_attributes][${newQuestionIndex}][title]" id="template_template_questions_attributes_${newQuestionIndex}_title" class="form-control">
            </div>
            <div class="flex items-center gap-4">
              <label for="template_template_questions_attributes_${newQuestionIndex}_question_type">Question Type</label>
              <select name="template[template_questions_attributes][${newQuestionIndex}][question_type]" id="template_template_questions_attributes_${newQuestionIndex}_question_type" class="form-control" data-role="type-select">
                <option value="radio">Radio</option>
                <option value="checkbox">Checkbox</option>
                <option value="text">Text</option>

              </select>
            </div>
            <div class="alternatives-container hidden" data-role="alternatives-container">
              <div class="flex items-center gap-4">
                <button type="button" class="btn btn-secondary" data-role="add-alternative">Add Alternative</button>
              </div>
              <div class="alternatives-list" data-role="alternatives-list">
              </div>
            </div>
          </div>
        </div>;
      questionsDiv.insertAdjacentHTML('beforeend', newQuestionFields);
    });

    document.addEventListener('change', function(e) {
      if (e.target.matches('[data-role="type-select"]')) {
        var questionFields = e.target.closest('.question-fields');
        var alternativesContainer = questionFields.querySelector('[data-role="alternatives-container"]');
        
        if (e.target.value === 'radio' || e.target.value === 'checkbox') {
          alternativesContainer.classList.remove('hidden');
        } else {
          alternativesContainer.classList.add('hidden');
          alternativesContainer.querySelector('[data-role="alternatives-list"]').innerHTML = '';
        }
      }
    });

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-role="add-alternative"]')) {
        var questionFields = e.target.closest('.question-fields');
        var alternativesList = questionFields.querySelector('[data-role="alternatives-list"]');
        var newAlternativeIndex = alternativesList.children.length;
        var questionIndex = questionFields.getAttribute('data-question-index');
        var newAlternativeFields = 
          <div class="flex items-center gap-4 alternative-field">
            <label for="alternative_${questionIndex}_${newAlternativeIndex}">Alternative</label>
            <input type="text" class="form-control alternative-input" name="template[template_questions_attributes][${questionIndex}][alternatives][${newAlternativeIndex}][content]">
          </div>;
        alternativesList.insertAdjacentHTML('beforeend', newAlternativeFields);
      }
    });
  });
<% end %>